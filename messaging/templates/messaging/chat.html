{% extends "base.html" %}
{% load static %}

{% block title %}Chat with {{ other_user.username }} | SkillBridge{% endblock %}

{% block content %}
<div
  class="flex flex-col h-[calc(100vh-8rem)] bg-white dark:bg-gray-900 rounded-2xl shadow-xl overflow-hidden max-w-6xl mx-auto border border-gray-100 dark:border-gray-700">

  <!-- HEADER -->
  <div
    class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-100 dark:border-gray-700 px-6 py-4 flex items-center justify-between z-10 relative">
    <div class="flex items-center gap-4">
      <!-- Back Button (Mobile) -->
      <a href="{% url 'inbox' %}"
        class="md:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i class="fa-solid fa-arrow-left"></i>
      </a>

      <!-- Avatar -->
      <a href="{% if other_user.user_type == 'job_seeker' %}{% url 'seeker_profile' other_user.id %}{% else %}#{% endif %}"
        class="relative">
        {% if other_user.avatar %}
        <img src="{{ other_user.avatar.url }}"
          class="w-10 h-10 rounded-full object-cover ring-2 ring-gray-100 dark:ring-gray-700">
        {% else %}
        <div
          class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm shadow-md">
          {{ other_user.username|slice:":1"|upper }}
        </div>
        {% endif %}
        <span
          class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white dark:ring-gray-800 bg-green-500"></span>
      </a>

      <!-- Info -->
      <div>
        <h2 class="text-base font-bold text-gray-900 dark:text-gray-100 leading-tight">
          {{ other_user.username }}
        </h2>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          {{ other_user.user_type|title|default:"User" }}
        </p>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center gap-4">
      <a href="{% url 'inbox' %}"
        class="hidden md:flex text-sm text-gray-500 hover:text-blue-600 font-medium transition items-center gap-2">
        <i class="fa-solid fa-chevron-left text-xs"></i> Back
      </a>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="flex-1 overflow-y-auto px-4 py-6 space-y-6 bg-gray-50 dark:bg-gray-900" id="chatContainer">

    {% for msg in messages %}
    <div class="flex w-full {% if msg.sender == user %}justify-end{% else %}justify-start{% endif %}">

      <div class="max-w-[80%] md:max-w-[70%] group relative">

        <!-- Sender Name (only for other user) -->
        {% if msg.sender != user %}
        <p class="text-[10px] text-gray-400 ml-1 mb-1 font-medium">
          {{ msg.sender.username }}
        </p>
        {% endif %}

        <!-- BUBBLE -->
        <div class="px-5 py-3 rounded-2xl shadow-sm text-sm leading-relaxed relative
                {% if msg.sender == user %}
                    bg-blue-600 text-white rounded-br-none
                {% else %}
                    bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700 rounded-bl-none
                {% endif %}">

          {{ msg.content|linebreaksbr }}

        </div>

        <!-- TIMESTAMP -->
        <div
          class="mt-1 flex items-center gap-1 {% if msg.sender == user %}justify-end text-blue-900/40 dark:text-blue-200/40{% else %}text-gray-400{% endif %}">
          <span class="text-[10px] font-medium opacity-70">
            {{ msg.timestamp|date:"g:i A"|lower }}
          </span>
          {% if msg.sender == user %}
          {% if msg.is_read %}
          <i class="fa-solid fa-check-double text-[10px] text-blue-500"></i>
          {% else %}
          <i class="fa-solid fa-check text-[10px]"></i>
          {% endif %}
          {% endif %}
        </div>
      </div>

    </div>
    {% empty %}
    <div class="flex flex-col items-center justify-center h-full opacity-50">
      <i class="fa-regular fa-comments text-4xl text-gray-300 dark:text-gray-600 mb-2"></i>
      <p class="text-sm text-gray-400 dark:text-gray-500">Start the conversation</p>
    </div>
    {% endfor %}

    <!-- Spacer for scrolling -->
    <div id="scrollAnchor"></div>
  </div>

  <!-- INPUT AREA -->
  <div
    class="p-4 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 sticky bottom-0 z-10 w-full mb-12">
    <div class="max-w-4xl mx-auto">

      <!-- Toolbar / Auto-Reply -->
      {% if not has_user_sent %}
      <div class="flex justify-end mb-2">
        <button type="button" id="autoReplyBtn"
          class="text-xs px-3 py-1.5 bg-gradient-to-r from-violet-100 to-fuchsia-100 dark:from-violet-900/30 dark:to-fuchsia-900/30 text-violet-700 dark:text-violet-300 rounded-full hover:shadow-md hover:scale-105 transition flex items-center gap-1.5 font-medium border border-violet-200 dark:border-violet-700/50">
          <i class="fa-solid fa-wand-magic-sparkles"></i> AI Rewrite / Auto-Reply
        </button>
      </div>
      {% endif %}

      <form method="POST" class="flex items-end gap-3 relative" id="chatForm">
        {% csrf_token %}

        <div class="flex-1 relative">
          <input type="text" name="content" id="messageInput" autocomplete="off" placeholder="Type your message..."
            class="w-full pl-5 pr-12 py-3.5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-gray-800 text-gray-900 dark:text-gray-100 transition shadow-inner">

          <!-- Optional Attachment Icon (Visual only) -->
          <button type="button"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
            <i class="fa-solid fa-paperclip"></i>
          </button>
        </div>

        <button type="submit"
          class="p-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl shadow-lg hover:shadow-blue-500/30 transition transform active:scale-95 flex items-center justify-center aspect-square">
          <i class="fa-solid fa-paper-plane text-lg"></i>
        </button>
      </form>
    </div>
  </div>

</div>

<!-- Auto-Scroll Script -->
<script>
  const chatContainer = document.getElementById('chatContainer');
  const scrollAnchor = document.getElementById('scrollAnchor');

  function scrollToBottom() {
    scrollAnchor.scrollIntoView({ behavior: 'auto' });
  }
  // Scroll on load
  scrollToBottom();

  // AI Logic
  document.getElementById('autoReplyBtn').addEventListener('click', function () {
    const btn = this;
    const originalText = btn.innerHTML;
    const input = document.getElementById('messageInput');

    // Simple visual feedback
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> processing...';
    btn.classList.add('opacity-75');

    fetch("{% url 'generate_reply' conversation.id %}")
      .then(response => response.json())
      .then(data => {
        if (data.reply) {
          input.value = data.reply;
          input.focus();

          // Visual pulse
          input.classList.add('ring-2', 'ring-green-400', 'bg-green-50', 'dark:bg-green-900/20');
          setTimeout(() => {
            input.classList.remove('ring-2', 'ring-green-400', 'bg-green-50', 'dark:bg-green-900/20');
          }, 600);

        } else {
          console.error('No reply');
        }
      })
      .catch(err => console.error(err))
      .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.classList.remove('opacity-75');
      });
  });
</script>
{% endblock %}